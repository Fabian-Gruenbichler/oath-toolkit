/*
 * tst_ocra_algo.c - self-tests for liboath OCRA algorithm functions
 * Copyright (C) 2013 Fabian Gr√ºnbichler
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public License
 * as published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
 * 02110-1301 USA
 *
 */

#include <config.h>

#include "oath.h"

#include <stdio.h>

const char *pHash =
  "\x71\x10\xed\xa4\xd0\x9e\x06\x2a\xa5\xe4\xa3\x90\xb0\xa5\x72\xac\x0d\x2c\x02\x20";

const struct
{
  char *secret;
  char *ocra_suite;
  uint64_t counter;
  char *challenges_hex;
  char *session;
  time_t now;
  char *ocra;
} tv[] =
{
  /* From RFC 6287. */
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "000000000", NULL,
      0, "237653"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "A98AC7", NULL, 0,
      "243178"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "153158E0", NULL, 0,
      "653583"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "1FCA0550", NULL, 0,
      "740991"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "2A62B1C0", NULL, 0,
      "608993"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "34FB5E30", NULL, 0,
      "388898"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "3F940AA0", NULL, 0,
      "816933"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "4A2CB710", NULL, 0,
      "224598"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "54C56380", NULL, 0,
      "750600"},
  {
  "12345678901234567890", "OCRA-1:HOTP-SHA1-6:QN08", 0, "5F5E0FF0", NULL, 0,
      "294470"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      0, "BC614E", NULL, 0, "65347737"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      1, "BC614E", NULL, 0, "86775851"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      2, "BC614E", NULL, 0, "78192410"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      3, "BC614E", NULL, 0, "71565254"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      4, "BC614E", NULL, 0, "10104329"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      5, "BC614E", NULL, 0, "65983500"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      6, "BC614E", NULL, 0, "70069104"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      7, "BC614E", NULL, 0, "91771096"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      8, "BC614E", NULL, 0, "75011558"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:C-QN08-PSHA1",
      9, "BC614E", NULL, 0, "08522129"},
    /* From RFC, changed to SHA1 */
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QN08-PSHA1", 0,
      "00000000", NULL, 0, "83238735"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QN08-PSHA1", 0,
      "A98AC7", NULL, 0, "01501458"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QN08-PSHA1", 0,
      "153158E0", NULL, 0, "17957585"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QN08-PSHA1", 0,
      "1FCA0550", NULL, 0, "86776967"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QN08-PSHA1", 0,
      "2A62B1C0", NULL, 0, "86807031"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 0, "00000000", NULL, 0, "07016083"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 1, "A98AC7", NULL, 0, "63947962"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 2, "153158E0", NULL, 0, "70123924"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 3, "1FCA0550", NULL, 0, "25341727"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 4, "2A62B1C0", NULL, 0, "33203315"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 5, "34FB5E30", NULL, 0, "34205738"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 6, "3F940AA0", NULL, 0, "44343969"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 7, "4A2CB710", NULL, 0, "51946085"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 8, "54C56380", NULL, 0, "20403879"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:C-QN08", 9, "5F5E0FF0", NULL, 0, "31409299"},
    /* epoch time 1206446790 == "Mar 25 2008, 12:06:30 GMT" */
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QN08-T1M", 0, "00000000", NULL, 1206446790,
      "95209754"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QN08-T1M", 0, "A98AC7", NULL, 1206446790,
      "55907591"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QN08-T1M", 0, "153158E0", NULL, 1206446790,
      "22048402"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QN08-T1M", 0, "1FCA0550", NULL, 1206446790,
      "24218844"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QN08-T1M", 0, "2A62B1C0", NULL, 1206446790,
      "36209546"},
    /* From RFC, changed to SHA, only server part, alpha-numeric
     * challenges hex-encoded */
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "434c4932323232305352563131313130", NULL, 0, "28247970"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "434c4932323232315352563131313131", NULL, 0, "01984843"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "434c4932323232325352563131313132", NULL, 0, "65387857"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "434c4932323232335352563131313133", NULL, 0, "03351211"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "434c4932323232345352563131313134", NULL, 0, "83412541"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "5352563131313130434c493232323230", NULL, 0, "15510767"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "5352563131313131434c493232323231", NULL, 0, "90175646"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "5352563131313132434c493232323232", NULL, 0, "33777207"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "5352563131313133434c493232323233", NULL, 0, "95285278"},
  {
  "12345678901234567890123456789012", "OCRA-1:HOTP-SHA256-8:QA08", 0,
      "5352563131313134434c493232323234", NULL, 0, "28934924"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08", 0, "434c4932323232305352563131313130",
      NULL, 0, "79496648"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08", 0, "434c4932323232315352563131313131",
      NULL, 0, "76831980"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08", 0, "434c4932323232325352563131313132",
      NULL, 0, "12250499"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08", 0, "434c4932323232335352563131313133",
      NULL, 0, "90856481"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08", 0, "434c4932323232345352563131313134",
      NULL, 0, "12761449"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08-PSHA1", 0,
      "5352563131313130434c493232323230", NULL, 0, "18806276"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08-PSHA1", 0,
      "5352563131313131434c493232323231", NULL, 0, "70020315"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08-PSHA1", 0,
      "5352563131313132434c493232323232", NULL, 0, "01600026"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08-PSHA1", 0,
      "5352563131313133434c493232323233", NULL, 0, "18951020"},
  {
  "1234567890123456789012345678901234567890123456789012345678901234",
      "OCRA-1:HOTP-SHA512-8:QA08-PSHA1", 0,
      "5352563131313134434c493232323234", NULL, 0, "32528969"}
  /* TODO plain signature test vectors */
  /* Note: all of the TODOs are already covered test cases until SHA256/512 is
   *       available. */
};


int
main (void)
{
  oath_rc rc;
  int i;

  rc = oath_init ();
  if (rc != OATH_OK)
    {
      printf ("oath_init: %d\n", rc);
      return 1;
    }

  for (i = 0; i < sizeof (tv) / sizeof (tv[0]); i++)
    {
      char output_ocra[strlen (tv[i].ocra) + 1];
      size_t bin_length = 0;
      rc = oath_hex2bin (tv[i].challenges_hex, NULL, &bin_length);
      char challenges_bin[bin_length];
      rc = oath_hex2bin (tv[i].challenges_hex, challenges_bin, &bin_length);

      rc = oath_ocra_generate (tv[i].secret, strlen (tv[i].secret),
			       tv[i].ocra_suite,
			       tv[i].counter, challenges_bin,
			       bin_length, pHash,
			       tv[i].session, tv[i].now, output_ocra);

      if (rc != OATH_OK)
	{
	  printf ("oath_ocra_generate at %d: %d\n", i, rc);
	  return 1;
	}

      if (strcmp (output_ocra, tv[i].ocra) != 0)
	{
	  printf ("wrong ocra value at %d: %s / %s\n", i, output_ocra,
		  tv[i].ocra);
	  return 1;
	}
    }
}
